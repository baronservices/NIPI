{% extends "base.html" %}

{% block title %}NIPI Dashboard - Baron Weather{% endblock %}

{% block header_gradient %}linear-gradient(135deg, #1f2937 0%, #374151 25%, #4b5563 50%, #374151 75%, #1f2937 100%){% endblock %}

{% block page_subtitle %}Real-time Network Intelligence Dashboard{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ capture_stats.packets_captured or 0 }}</div>
        <div class="stat-label">Packets Captured</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ recent_packets or 0 }}</div>
        <div class="stat-label">Last Hour</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ active_hosts or 0 }}</div>
        <div class="stat-label">Active Hosts</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ security_events or 0 }}</div>
        <div class="stat-label">Security Events</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">
            <span class="status-indicator {% if capture_stats.get('runtime_seconds') %}status-active{% else %}status-inactive{% endif %}"></span>
            {% if capture_stats.get('runtime_seconds') %}Running{% else %}Stopped{% endif %}
        </div>
        <div class="stat-label">Capture Status</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ "%.1f"|format(capture_stats.packets_per_second or 0) }}</div>
        <div class="stat-label">Packets/sec</div>
    </div>
</div>

<div class="card">
    <div class="section-header">
        <span>üìä Real-time Network Overview</span>
    </div>
    <div class="card-body">
        {% if capture_stats.get('runtime_seconds') %}
        <div class="alert alert-info">
            <strong>Capture Active:</strong> Running for {{ "%.0f"|format(capture_stats.runtime_seconds / 60) }} minutes. 
            Queue size: {{ capture_stats.queue_size or 0 }}, Active flows: {{ capture_stats.active_flows or 0 }}
        </div>
        {% else %}
        <div class="alert alert-warning">
            <strong>Capture Stopped:</strong> No active packet capture. <a href="/capture" class="btn btn-sm">Start Capture</a>
        </div>
        {% endif %}
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div>
                <h4>Bandwidth Statistics</h4>
                <p><strong>Bytes Captured:</strong> {{ "%.2f"|format((capture_stats.bytes_captured or 0) / 1024 / 1024) }} MB</p>
                <p><strong>Packets Processed:</strong> {{ capture_stats.packets_processed or 0 }}</p>
                <p><strong>Packets Dropped:</strong> {{ capture_stats.packets_dropped or 0 }}</p>
            </div>
            <div>
                <h4>System Health</h4>
                <p><strong>Memory Usage:</strong> <span class="status-indicator status-active"></span> Normal</p>
                <p><strong>Database:</strong> <span class="status-indicator status-active"></span> Connected</p>
                <p><strong>Analysis Engine:</strong> <span class="status-indicator status-active"></span> Active</p>
            </div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="card">
        <div class="section-header">
            <span>üèÜ Top Network Talkers (24h)</span>
        </div>
        <div class="card-body">
            {% if top_talkers %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Host</th>
                        <th>IP Address</th>
                        <th>Data Transfer</th>
                    </tr>
                </thead>
                <tbody>
                    {% for talker in top_talkers %}
                    <tr>
                        <td>{{ talker.hostname or 'Unknown' }}</td>
                        <td>{{ talker.ip_address }}</td>
                        <td>{{ "%.2f"|format((talker.total_bytes or 0) / 1024 / 1024) }} MB</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted">No bandwidth data available yet.</p>
            {% endif %}
        </div>
    </div>
    
    <div class="card">
        <div class="section-header">
            <span>üîí Recent Security Events</span>
        </div>
        <div class="card-body">
            {% if recent_security_events %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Severity</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in recent_security_events %}
                    <tr>
                        <td>{{ event.timestamp.strftime('%H:%M') }}</td>
                        <td>{{ event.event_type.replace('_', ' ').title() }}</td>
                        <td>
                            <span class="status-indicator 
                                {% if event.severity == 'critical' %}status-inactive
                                {% elif event.severity == 'high' %}status-warning
                                {% else %}status-active{% endif %}"></span>
                            {{ event.severity.title() }}
                        </td>
                        <td>{{ event.source_ip }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted">No security events detected.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <div class="section-header">
        <span>‚ö° Quick Actions</span>
    </div>
    <div class="card-body">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/capture" class="btn">Manage Capture</a>
            <a href="/analysis" class="btn">View Analysis</a>
            <a href="/security" class="btn">Security Dashboard</a>
            <a href="/performance" class="btn">Performance Metrics</a>
            <button onclick="refreshData()" class="btn btn-warning">Refresh Data</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshData() {
    location.reload();
}

// Auto-refresh every 30 seconds
setInterval(refreshData, 30000);

// Real-time updates for capture stats
function updateCaptureStats() {
    fetch('/capture/stats')
        .then(response => response.json())
        .then(data => {
            // Update stats display
            document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = data.packets_captured || 0;
            document.querySelector('.stat-card:nth-child(6) .stat-value').textContent = (data.packets_per_second || 0).toFixed(1);
        })
        .catch(error => console.error('Error updating stats:', error));
}

// Update stats every 5 seconds
setInterval(updateCaptureStats, 5000);
</script>
{% endblock %}